--set mapred.job.queue.name=root.dsc;
--set hive.execution.engine=tez;

set mapred.job.queue.name=default;
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT OVERWRITE TABLE dsc_dim.dim_dsc_item_info
select 
		t2.wms_company_id,
        t2.wms_company_name,
        t2.sku_code,
        t2.sku_name,
        t2.sku_desc,
        t2.sku_status,       
        t2.product_line,        
        t2.product_category,
        t2.product_group,
        t2.product_sub_group,
        t2.product_type,
        t2.sale_group,
        t2.store_department,
        t2.conversion_qty,
        t2.quantity_um,
        t2.length,
        t2.width,
        t2.height,
        t2.weight,
        t2.volume,
        t2.weight_um,
        t2.volume_um,
        t2.std_pack_height,
        t2.std_pack_length,
        t2.std_pack_width,
        t2.std_pack_volume,
        t2.std_pack_weight,
        t2.std_pack_qty,
        t2.std_case_height,
        t2.std_case_length,
        t2.std_case_width,
        t2.std_case_volume,
        t2.std_case_weight,
        t2.std_case_qty,
        t2.obsolete_col,
        t2.obsolete_col2,
        t2.putaway_type,
        t2.allocation_type,
        t2.load_time,
        t2.create_date,
        t2.last_modified_date,
        t2.data_source 
from (
select
*,
row_number() over(partition by t1.sku_code order by t1.last_modified_date desc) as rn 
from 
(
    select 
        * 
    from dsc_dim.dim_dsc_item_info di where data_source = 'wmos'
    union all 
    select 
        ic.company_id as wms_company_id,
        null as wms_company_name,
        ic.item_id as sku_code,
        ic.item_name as sku_name,
        ic.description as sku_desc,
        ic.status_code as sku_status,
        --iw.prod_line as product_line,
        '' as product_line,
        --iw.prod_catgry as product_category,
        '' as product_category,
        null as product_group,
        --iw.prod_sub_grp as product_sub_group,
        '' as product_sub_group,
        ic.prod_type as product_type,
        --iw.sale_grp as sale_group,
        '' as sale_group,
        null as store_department,
        null as conversion_qty,
        null as quantity_um,
        ic.unit_length as length,
        ic.unit_width as width,
        ic.unit_height as height,
        ic.unit_weight as weight,
        ic.unit_volume as volume,
        null as weight_um,
        null as volume_um,
        null as std_pack_height,
        null as std_pack_length,
        null as std_pack_width,
        null as std_pack_volume,
        null as std_pack_weight,
        ic.std_bundl_qty as std_pack_qty,
        null as std_case_height,
        null as std_case_length,
        null as std_case_width,
        null as std_case_volume,
        null as std_case_weight,
        null as std_case_qty,
        null as obsolete_col,
        null as obsolete_col2,
        null as putaway_type,
        null as allocation_type,
        null as load_time,
        ic.created_dttm as create_date,
        ic.last_updated_dttm as last_modified_date,
        'wmos' as data_source
    from ods_wmos.item_cbo ic where ic.inc_day = '$[time(yyyyMMdd,-1d)]' 
)t1 
)t2
where t2.rn = 1 


union all
--scale
select 
itm.company as wms_company_id,
itm.company as wms_company_name,
itm.item as sku_code,
itm.`description` as sku_name,
itm.`description` as sku_desc,
itm.`active` as sku_status,
null as product_line,
itm.item_category1 as product_category ,
itm.item_category2 as product_group,
itm.item_category3 as product_sub_group,
itm.ITEM_STYLE as product_type,
null as sale_group,
null as store_department,
IUOM.conversion_qty as conversion_qty,
IUOM.QUANTITY_UM as quantity_um,
IUOM.LENGTH as length,
IUOM.WIDTH as width,
IUOM.HEIGHT as height,
IUOM.WEIGHT as weight,
IUOM.USER_DEF8 as volumn,
weight_um as weight_um,
null as volume_um,
null as std_pack_height,
null as std_pack_length,
null as std_pack_width,
null as std_pack_volume,
null as std_pack_weight,
null as std_pack_qty,
null as std_case_height,
null as std_case_length,
null as std_case_width,
null as std_case_volume,
null as std_case_weight,
null as std_case_qty,
null as obsolete_col,
null as obsolete_col2,
null as putaway_type,
null as allocation_type,
null as load_time,
null as create_date,
itm.date_time_stamp as last_modified_date,
itm.data_source
from
(select
itm.company as wms_company_id,
itm.company as wms_company_name,
itm.item as sku_code,
itm.`description` as sku_name,
itm.`description` as sku_desc,
itm.`active` as sku_status,
null as product_line,
itm.item_category1 as product_category ,
itm.item_category2 as product_group,
itm.item_category3 as product_sub_group,
itm.ITEM_STYLE as product_type,
null as sale_group,
null as store_department,
IUOM.conversion_qty as conversion_qty,
IUOM.QUANTITY_UM as quantity_um,
IUOM.LENGTH as length,
IUOM.WIDTH as width,
IUOM.HEIGHT as height,
IUOM.WEIGHT as weight,
IUOM.USER_DEF8 as volumn,
IUOM.weight_um as weight_um,
null as volume_um,
null as std_pack_height,
null as std_pack_length,
null as std_pack_width,
null as std_pack_volume,
null as std_pack_weight,
null as std_pack_qty,
null as std_case_height,
null as std_case_length,
null as std_case_width,
null as std_case_volume,
null as std_case_weight,
null as std_case_qty,
null as obsolete_col,
null as obsolete_col2,
null as putaway_type,
null as allocation_type,
null as load_time,
null as create_date,
itm.date_time_stamp as last_modified_date,
itm.data_source,
row_number() over (partition by 
sku_code,quantity_um,data_source,wms_company_id 
order by last_modified_date) as  rn
from dsc_dwd.dwd_wh_scale_item_mid_di as itm
left join dsc_dwd.dwd_scale_item_unit_of_measure_mid_di as iuom

ON itm.ITEM = iuom.ITEM
and itm.company = iuom.company
and itm.data_source = iuom.data_source
and iuom.inc_day = '$[time(yyyyMMdd,-1d)]' 

WHERE itm.inc_day = '$[time(yyyyMMdd,-1d)]' ) a 
where rn =1
---
----------------
---ttx
union all

SELECT wms_company_id,wms_company_name,sku_code,sku_name,sku_desc,sku_status,product_line,product_category,product_group,product_sub_group,product_type,sale_group,store_department,conversion_qty,quantity_um,length,width,height,weight,volume,weight_um,volume_um,std_pack_height,std_pack_length,std_pack_width,std_pack_volume,std_pack_weight,std_pack_qty,std_case_height,std_case_length,std_case_width,std_case_volume,std_case_weight,std_case_qty,obsolete_col,obsolete_col2,putaway_type,allocation_type,load_time,create_date,last_modified_date,data_source 

from

(
select
companycode as wms_company_id,
companycode as wms_company_name,
code as sku_code,
name as sku_name,
null as sku_desc,
status as sku_status,
null as product_line,
itemcategory1 as product_category ,null as product_group,null as product_sub_group,null as product_type,
null as sale_group,
null as store_department,
null as conversion_qty,
unitdesc as quantity_um,
unitLength as length,
unitWidth as width,
unitHeight as height,
unitWeight as weight,
unitVolume as volume,
null as weight_um,
null as volume_um,
csheight as std_pack_height,cslength as std_pack_length,cswidth as std_pack_width,csvolume as std_pack_volume,csweight as std_pack_weight,csQty as std_pack_qty,
plHeight as std_case_height,
plLength as std_case_length,
plWidth as std_case_width,
plVolume as std_case_volume,
plWeight as std_case_weight,
plQty as std_case_qty,
trackmanufacturedate as obsolete_col,trackexpirationdate as obsolete_col2,
locatingRule as putaway_type,
allocationRule as allocation_type,
null as load_time,
created as create_date,lastupdated as last_modified_date,
data_source as data_source,
--重复值随机取
row_number() over (partition by code,companycode,data_source order by lastupdated) as  rn
from dsc_dwd.dwd_wh_ttx_item_mid_di
WHERE inc_day = '$[time(yyyyMMdd,-1d)]' )a
where rn =1
